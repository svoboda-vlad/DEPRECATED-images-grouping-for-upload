<h2 class="my-width mx-auto">Grouping and resizing images for uploading to Google Photos</h2>

<form [formGroup]="inputFilesForm">
  <div class="form-group my-width mx-auto">
    <label for="inputFiles">Select images for grouping</label>
    <input class="form-control" id="inputFiles" #file type="file" accept="image/*" (change)="processFiles(file.files)"
      multiple />
  </div>
</form>

<div class="card p-3 mb-2 bg-light text-dark my-width mx-auto" *ngIf="filesCount">
  <div class="card-body">
    <p class="card-text text-danger" *ngIf="mediaItems.length != filesCount">Resizing in progress
      ({{ mediaItems.length }} of {{ filesCount }})</p>
    <p class="card-text text-primary" *ngIf="mediaItems.length == filesCount">Finished: {{ mediaItems.length }} files
      resized to {{ resizeWidth }}x{{ resizeHeight }}px.</p>
  </div>
</div>

<div *ngIf="filesLoaded">
  <div class="card p-3 mb-2 bg-light text-dark my-width mx-auto">
    <div class="card-body">
      <button class="btn btn-primary mb-2" (click)="createGroups()" [disabled]="groupsCreated">
        Create groups
      </button>
      <p class="card-text" *ngIf="getUniqueMediaItemsCount()">
        {{ getUniqueMediaItemsCount() }} files without duplicates in
        {{ mediaItemsGroups.length }} groups
      </p>
    </div>
  </div>
</div>

<div *ngIf="getUniqueMediaItemsCount()">
  <h3 class="my-width mx-auto">Images in groups</h3>

  <div class="my-width-groups mx-auto">
    <div *ngFor="let group of mediaItemsGroups" class="card border p-3 mb-2">
      <div class="card-header">
        <button (click)="changeShowGroup(group)"
          class="btn btn-primary mb-2">{{ group.show ? 'Hide images' : 'Show images' }}</button><br />
        <div *ngIf="group.show">
          <button (click)="changeLargePreview(group)"
            class="btn btn-secondary mb-2">{{ group.largePreview ? 'Small preview' : 'Large preview' }}</button>
          <button (click)="changeShowOnlyDuplicates(group)"
            class="btn btn-secondary mb-2" *ngIf="(group.mediaItemsForGrouping.length - group.getCountWithoutDuplicates()) > 0 || group.showOnlyDuplicates">
            {{ group.showOnlyDuplicates ? 'Hide duplicates' : 'Show ' + (group.mediaItemsForGrouping.length - group.getCountWithoutDuplicates()) + ' duplicates' }}
          </button>
        </div>
        <h5 #groupName contenteditable (blur)="updateGroupName(group, groupName.textContent)">{{ group.name }}</h5>
        <div>{{ group.getCountWithoutDuplicates() }} unique files (of {{ group.mediaItemsForGrouping.length }})</div>
        <button (click)="removeGroup(group)" class="btn btn-primary mb-2" *ngIf="group.show">Remove group</button>
      </div>

      <div class="card-body group" *ngIf="group.show">
        <div *ngFor="let item of group.mediaItemsForGrouping">
          <div class="file p-3 mb-2"
            *ngIf="(group.showOnlyDuplicates && item.isDuplicate == 'Y') || (!group.showOnlyDuplicates && item.isDuplicate == 'N')">
            {{ item.mediaItem.dateTime | date: "HH:mm:ss" }}<br />
            <img [ngClass]="group.largePreview ? 'large-img': 'small-img'" [src]="item.mediaItem.contentUrl" /><br />
            <button (click)="changeIsDuplicate(group, item)" class="btn btn-primary mb-2">
              {{ item.isDuplicate === "Y" ? "Add" : "Remove" }}</button>
            <div>
              {{ item.mediaItem.uploadSuccess ? "Uploaded" : "Not uploaded" }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<div *ngIf="mediaItemsGroups.length">
  <h3 class="my-width mx-auto">Groups overview</h3>

  <table class="table table-bordered my-width mx-auto p-3 mb-2">
    <th>Group</th>
    <th>Days</th>
    <th>Album</th>
    <th>Files</th>
    <th>Uploaded</th>
    <th>Not uploaded</th>
    <tr *ngFor="let group of mediaItemsGroups">
      <td>{{ group.name }}</td>
      <td>{{ getDaysDiffFromToday(group.startTime) }}</td>
      <td>{{ group.albumId ? 'CREATED' : 'not created' }}</td>
      <td>{{ group.getCountWithoutDuplicates() }}</td>
      <td>{{ group.getUploadedCount() }}</td>
      <td>{{ group.getCountWithoutDuplicates() - group.getUploadedCount() }}</td>
    </tr>
    <tr>
      <td>Total</td>
      <td></td>
      <td></td>
      <td>{{ getUniqueMediaItemsCount() }}</td>
      <td>{{ getUploadedCount() }}</td>
      <td>{{ getUniqueMediaItemsCount() - getUploadedCount() }}</td>
    </tr>
  </table>

  <h3 class="my-width mx-auto">Upload to Google Photos</h3>

  <div class="card p-3 mb-2 bg-light text-dark my-width mx-auto">
    <div class="card-body">
      <p class="card-text">
        <button (click)="createAlbumsAndMedia()" class="btn btn-primary mb-2" [disabled]="!accessToken">Create albums
          and upload files to Google Photos</button>
      </p>
      <p class="card-text text-danger" *ngIf="!accessToken">Please enter access token</p>
      <p class="card-text text-danger" *ngIf="uploadingStatus == 'InProgress'">UPLOADING IN PROGRESS</p>
      <p class="card-text text-primary" *ngIf="uploadingStatus == 'Success'">UPLOADING SUCCESSFULLY FINISHED</p>
      <p class="card-text text-danger" *ngIf="uploadingStatus == 'Fail'">UPLOADING FAILED (see the Groups Overview table for details)</p>
    </div>
  </div>
</div>

<form [formGroup]="uploadForm">
  <div class="form-group my-width mx-auto">
    <label for="accessToken">Access Token (from OAuth 2.0 Playground)</label><br />
    <input class="form-control" id="accessToken" type="text" formControlName="accessToken" (blur)="saveAccessToken()" />
  </div>
</form>

<div class="card p-3 mb-2 bg-light text-dark my-width mx-auto">
  <div class="card-header">How to get access token to Google Photos</div>
  <div class="card-body">
    <p class="card-text">
      1) Open
      <a href="https://developers.google.com/oauthplayground/#step1&scopes=https%3A//www.googleapis.com/auth/photoslibrary.appendonly"
        target="_blank">OAuth 2.0 Playground</a>
    </p>
    <h6 class="card-subtitle mb-2 text-muted">On OAuth 2.0 Playground page</h6>
    <p class="card-text">
      2) In section "Step 1 Select & authorize APIs", the required scope
      (<code>https://www.googleapis.com/auth/photoslibrary.appendonly</code>) is already filled in the
      <kbd>Input your own scopes</kbd> field
    </p>
    <p class="card-text">3) Click on <kbd>Authorize APIs</kbd> button</p>
    <p class="card-text">4) Log in to your Google account</p>
    <p class="card-text">
      5) On "Google OAuth 2.0 Playground wants to access your Google Account"
      screen, click on <kbd>Allow</kbd> button
    </p>
    <p class="card-text">
      6) In section "Step 2 Exchange authorization code for tokens", click on
      <kbd>Exchange authorization code for tokens</kbd> button
    </p>
    <p class="card-text">7) Copy token from <kbd>Access token</kbd> field</p>
    <h6 class="card-subtitle mb-2 text-muted">On this page</h6>
    <p class="card-text">
      8) Paste the token to
      <kbd>Access Token (from OAuth 2.0 Playground)</kbd> field
    </p>
  </div>
</div>
